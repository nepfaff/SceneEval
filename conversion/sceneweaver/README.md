# Converting SceneWeaver Scenes for SceneEval

This guide explains how to convert scenes generated by SceneWeaver into a format compatible with SceneEval.

This guide assumes you have already set up SceneEval by following the instructions in the main [README.md](../../README.md).

## Prerequisites

### 1. Blender Installation
The conversion script requires **Blender 4.2.x** (not 5.x) with Python API support.

**Important**: SceneEval's evaluation pipeline uses `bpy` 4.2 from pip. Blender 5.x files are **not backwards compatible** with Blender 4.2, so you must use Blender 4.2.x for conversion.

```bash
# Example: Use Blender 4.2 explicitly
/path/to/blender-4.2.0-linux-x64/blender --background --python conversion/sceneweaver/convert_SceneEval.py -- ...
```

Blender is used to:
- Open SceneWeaver's `.blend` files
- Bake procedural materials to textures
- Export objects as GLB files

### 2. SceneWeaver Output
You need SceneWeaver scene output directories. By default, SceneWeaver saves scenes to:
```
SceneWeaver/Pipeline/output/scene_NNN/
```

Each scene directory contains:
- `args.json` - Scene metadata with final iteration number
- `roominfo.json` - Room type and dimensions
- `record_files/scene_N.blend` - Blender files for each iteration
- `record_scene/layout_N.json` - Object placement data

---

## Running the Conversion

From the **SceneEval** directory:

```bash
blender --background --python conversion/sceneweaver/convert_SceneEval.py -- \
    --input_dir /path/to/SceneWeaver/Pipeline/output/scene_000 \
    --output_dir /path/to/SceneEval/input/SceneWeaver \
    --scene_id 0
```

### Options

| Option | Description | Default |
|--------|-------------|---------|
| `--input_dir` | Path to SceneWeaver scene directory (required) | - |
| `--output_dir` | Output directory for converted files | `./input/SceneWeaver` |
| `--scene_id` | Scene ID for output filename | `0` |
| `--wall_height` | Wall height in meters | `2.8` |
| `--export_architecture` | Export floor/wall meshes from SceneWeaver | `false` |

### Batch Conversion Example

To convert multiple scenes with specific IDs:

```bash
# Scene 000 -> scene_106
blender --background --python conversion/sceneweaver/convert_SceneEval.py -- \
    --input_dir /path/to/SceneWeaver/output/scene_000 \
    --output_dir input/SceneWeaver --scene_id 106

# Scene 001 -> scene_56
blender --background --python conversion/sceneweaver/convert_SceneEval.py -- \
    --input_dir /path/to/SceneWeaver/output/scene_001 \
    --output_dir input/SceneWeaver --scene_id 56
```

---

## How It Works

### 1. Object Discovery

The script identifies placed scene objects by matching the pattern:
```
{FactoryType}({seed}).spawn_asset({seed2})
```

Examples:
- `BedFactory(3164690).spawn_asset(7191960)`
- `ChairFactory(9347996).spawn_asset(5189805)`
- `ObjaverseCategoryFactory(1210932).spawn_asset(7874330)`

### 2. Object Filtering

**Not all objects in the Blender file should be exported.** SceneWeaver stores raw asset templates in special collections that are hidden from rendering.

Objects are **excluded** if they are in:
- Collections prefixed with `assets:` (e.g., `assets:fruit`) - raw asset templates for scattering
- Collections prefixed with `placeholders:` - placeholder geometry
- Collections with `hide_render=True`

This filtering is critical because:
- Raw assets (like fruits for scatter) exist at origin with massive scale
- These templates are used by `scatter_instances()` to populate containers
- Exporting them would result in giant misplaced objects in the scene

### 3. Material Baking

SceneWeaver uses Infinigen's procedural materials (noise, voronoi, etc.) which don't export directly to glTF. The script:

1. Detects procedural materials by checking for noise/procedural nodes
2. Rewires texture coordinates from Object/Generated to UV coordinates
3. Creates smart UV projections if needed
4. Bakes materials to 1024x1024 PNG textures using Cycles EMIT bake
5. Replaces procedural shaders with image textures

### 4. GLB Export

Each object is exported as an individual GLB file with:
- `export_apply=True` - World transforms baked into vertex positions
- `export_yup=True` - Standard glTF Y-up coordinate system
- Identity transform in scene state (transforms are in the GLB)

### 5. Architecture Generation

By default, the script generates simple rectangular architecture from room dimensions:
- Floor polygon from `roomsize` in `roominfo.json`
- 4 walls with configurable height (default 2.8m)

Use `--export_architecture` to export SceneWeaver's actual floor/wall meshes with baked textures.

### 6. Blend File Cleanup

When saving the `original_sceneweaver.blend` file, the script:
1. **Removes raw asset objects** in `assets:*` and `placeholders:*` collections
2. **Deletes empty collections** that held those assets
3. **Purges orphan data** (unused meshes, materials, textures)

This cleanup:
- Fixes camera framing issues (giant template objects would expand scene bounds)
- Reduces file size (typically 10-15% smaller)
- Makes the scene cleaner for manual inspection

---

## Output Format

The conversion produces:

```
input/SceneWeaver/
├── scene_0.json                    # Scene state JSON
└── scene_0/
    └── assets/
        ├── 3164690_BedFactory_7191960.glb
        ├── 9347996_ChairFactory_5189805.glb
        ├── *_baked.png             # Baked material textures
        └── original_sceneweaver.blend
```

### Object ID Format

Object IDs follow the pattern: `{seed}_{FactoryType}_{spawn_seed}`

Examples:
- `3164690_BedFactory_7191960`
- `9347996_ChairFactory_5189805`
- `51232_FruitFactoryPineapple_0`

The `spawn_seed` ensures unique IDs when multiple instances share the same factory seed.

---

## Troubleshooting

### "Failed to read blend file" Error

If SceneEval fails with:
```
Error: Loading "...original_sceneweaver.blend" failed: Failed to read blend file '...', not a blend file
```

**Cause**: The blend file was saved with Blender 5.x, but SceneEval uses Blender 4.2 (`bpy` from pip). Blender 4.2 cannot open files saved by Blender 5.x.

**Solution**: Re-run the conversion using Blender 4.2.x:
```bash
/path/to/blender-4.2.0-linux-x64/blender --background --python conversion/sceneweaver/convert_SceneEval.py -- ...
```

### Giant Objects in Render

If you see massive objects (like giant pineapples) in the SceneEval render:

**Cause**: Raw asset templates from `assets:*` collections were exported. These are template meshes stored at origin with large scale, used for scattering onto containers.

**Solution**: The conversion script should filter these automatically. If not, check that:
1. The collection filtering is working (`is_in_hidden_or_asset_collection()`)
2. The collection has `hide_render=True` or is prefixed with `assets:`

### Missing Objects

If objects are missing from the converted scene:

**Cause**: Objects may be in hidden collections or marked as placeholders.

**Check**:
- Verify the object appears in the layout JSON
- Check if the object is in a `placeholders:*` collection
- Confirm `hide_render=False` on the object and its collections

### Material Baking Errors

If materials appear incorrect or baking fails:

**Common issues**:
- Object not enabled for rendering: Enable the object in Blender
- Circular image dependencies: Expected warning, baking continues
- Missing UV coordinates: Script creates smart UV projection

---

## Coordinate System

SceneWeaver uses Blender's coordinate system (Z-up), which matches SceneEval:

| Axis | Direction |
|------|-----------|
| +X | Right |
| +Y | Forward |
| +Z | Up |

The glTF export uses Y-up, which is automatically converted back to Z-up on import.
